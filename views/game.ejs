<%- include('partials/header') %>


  <div class="wrapper">
    <a href="/games" class="back-link">‚Üê Back to Games</a>

    <div class="game-container">

    <div class="game-card-info">
      <img src="<%= game.cover ? game.cover.url.replace('t_thumb', 't_cover_big') : '/placeholder.jpg' %>" alt="<%= game.name %>" class="cover">

      <div class="game-card-meta">

        <% if (game.first_release_date) { %>
          <p><strong>Release Date:</strong> <%= new Date(game.first_release_date * 1000).toLocaleDateString() %></p>
        <% } %>

        <% if (game.rating) { %>
          <p><strong>Rating:</strong> <%= game.rating.toFixed(1) %>/100</p>
        <% } %>

        <% if (game.popularity) { %>
          <p><strong>Popularity:</strong> <%= Math.round(game.popularity) %></p>
        <% } %>

        <% if (game.platforms) { %>
          <p><strong>Platforms:</strong> <%= game.platforms.map(p => p.name).join(', ') %></p>
        <% } %>

        <% if (game.genres) { %>
          <p><strong>Genres:</strong> <%= game.genres.map(g => g.name).join(', ') %></p>
        <% } %>

       <% if (user) { %>
          <% if (inLibrary) { %>
            <form action="/library/remove" method="POST">
              <input type="hidden" name="game_id" value="<%= game.id %>">
              <button type="submit" class="button">Remove</button>
            </form>
          <% } else { %>
            <form action="/library/add" method="POST">
              <input type="hidden" name="game_id" value="<%= game.id %>">
              <input type="hidden" name="game_name" value="<%= game.name %>">
               <input type="hidden" name="cover_url" value="<%= game.cover.url %>">
              <button type="submit" class="button">Add to Library</button>
            </form>
          <% } %>
        <% } else { %>
          <a href="/login">Login to add this game to your library</a>
        <% } %>
      </div>
    </div>

    <div class="game-summary">
      <h1 class="game-name"><%= game.name %></h1>

      <% if (game.summary) { %>
        <!-- <h2>Summary</h2> -->
        <p class="summary-text"><%= game.summary %></p>
      <% } %>

      <!-- <% if (game.storyline) { %>
        <h2>Storyline</h2>
        <p><%= game.storyline %></p>
      <% } %> -->

      <% if (game.screenshots) { %>
        <!-- <h2>Screenshots</h2> -->
        <div class="screenshots">
          <% game.screenshots.forEach(ss => { %>
            <img src="<%= ss.url.replace('t_thumb', 't_1080p') %>" alt="Screenshot">
          <% }) %>
        </div>

        <div class="comments-section">
          <h2>Comments</h2>

          <% if (user) { %>
            <form action="/comments/<%= game.id %>" method="POST" class="comment-form">
              <textarea name="content" rows="3" required placeholder="Write your comment..."></textarea>
              <button type="submit" class="button">Post Comment</button>
            </form>
          <% } else { %>
            <p><a href="/login">Login</a> to post a comment.</p>
          <% } %>

          <% if (comments && comments.length > 0) { %>
            <div class="comments-box">
            <ul class="comment-list"></ul>
          <% comments.forEach(comment => { %>
            <li class="comment">
              <div class="comment-header">
                <p class="comment-meta">
                  <strong><%= comment.username %></strong>
                  <span class="date"><%= new Date(comment.created_at).toLocaleString() %></span>

                  <% if (comment.edited_at) { %>
                    <span class="edited">(edited <%= new Date(comment.edited_at).toLocaleString() %>)</span>
                  <% } %>
                </p>
            
                <% if (user && user.id === comment.user_id) { %>
                  <form action="/comments/<%= comment.id %>/delete" method="POST" class="delete-form">
                    <button type="button" class="edit-button" onclick="startEdit(<%= comment.id %>)">Edit</button>
                    <span>|</span>
                    <button type="submit" class="delete-button" onclick="return confirm('Delete this comment?')">Delete</button>
                  </form>
                <% } %>
              </div>
                <!-- Display mode -->
                <p class="comment-content" id="content-<%= comment.id %>"><%= comment.content %></p>

                <!-- Edit mode (hidden by default) -->
                <form action="/comments/<%= comment.id %>/edit" method="POST" class="edit-form" id="form-<%= comment.id %>" style="display: none;">
                  <textarea name="content" rows="2" required><%= comment.content %></textarea>
                  <button type="submit" class="button">Save</button>
                  <button type="button" class="button cancel-button" onclick="cancelEdit(<%= comment.id %>)">Cancel</button>
                </form>
            </li>
          <% }) %>
          </ul>
          </div>
          <% } else { %>
            <p>No comments yet. Be the first to write one!</p>
          <% } %>
        </div>
      <% } %>
    </div>
  </div>

  

  </div>
  <%- include('partials/footer') %>

  <script>
function startEdit(commentId) {
  document.getElementById(`content-${commentId}`).style.display = 'none';
  document.getElementById(`form-${commentId}`).style.display = 'block';
}

function cancelEdit(commentId) {
  document.getElementById(`form-${commentId}`).style.display = 'none';
  document.getElementById(`content-${commentId}`).style.display = 'block';
}
</script>